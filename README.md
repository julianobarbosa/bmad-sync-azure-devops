# BMAD Sync Azure DevOps

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](LICENSE)
[![Python 3.6+](https://img.shields.io/badge/python-3.6%2B-blue.svg)](https://www.python.org/downloads/)
[![Tests](https://github.com/cfpeterkozak/bmad-sync-azure-devops/actions/workflows/ci.yml/badge.svg)](https://github.com/cfpeterkozak/bmad-sync-azure-devops/actions/workflows/ci.yml)

A [BMAD Method](https://github.com/bmadcode/BMAD-METHOD) workflow that syncs your local planning artifacts to Azure DevOps as live work items. Keeps your markdown-based epics, stories, and tasks in sync with an Azure DevOps board — with incremental updates, content-hash change detection, drift auditing, and bug discovery.

## What is this?

The [BMAD Method](https://github.com/bmadcode/BMAD-METHOD) (BMad Agentic Development) is an AI-agent-driven software development framework where planning artifacts (PRD, architecture, epics, stories) live as structured markdown files in your repo. AI agents follow step-by-step workflows to create and maintain these artifacts.

**The problem:** Your team plans in BMAD's markdown files, but project managers and stakeholders track work in Azure DevOps. Keeping both in sync manually is tedious and error-prone.

**This workflow solves that** by parsing your BMAD `epics.md` and story files, computing content hashes for change detection, and pushing new/changed items to Azure DevOps via the `az boards` CLI. On subsequent runs, only changed items are synced. You can also audit for drift and discover new bugs filed in DevOps.

## How it works

```
epics.md ──┐
            ├── Parse → Hash → Diff → Dry-Run → [User Confirms] → az boards CLI → devops-sync.yaml
story files ┘
```

1. **Parse** your BMAD markdown files (epics, stories, tasks, review follow-ups, epic statuses)
2. **Hash** each item's content using normalized SHA-256 for reliable change detection
3. **Diff** against the last sync state — classify items as new/changed/unchanged/orphaned
4. **Dry-run** shows exactly what will happen — you confirm before any API calls
5. **Sync** creates/updates work items via `az boards` CLI in dependency order (Epics → Stories → Tasks → Iterations), including epic and story state mapping
6. **Map** saves all Azure DevOps work item IDs and hashes to `devops-sync.yaml` for future incremental runs

## Prerequisites

| Requirement | Details |
|-------------|---------|
| [BMAD Method](https://github.com/bmadcode/BMAD-METHOD) | Installed in your project with BMM module |
| Python 3.6+ | For helper scripts (stdlib only — no pip install needed) |
| Azure CLI | [Install guide](https://learn.microsoft.com/en-us/cli/azure/install-azure-cli) |
| azure-devops extension | `az extension add --name azure-devops` |
| Personal Access Token | With **Work Items: Read, write, & manage** scope |
| Azure DevOps project | Must exist before first sync |
| `epics.md` | Generated by the BMAD Create Epics and Stories workflow |

## Installation

Copy this workflow into your BMAD project:

```bash
# Option A: Git submodule (recommended — enables version-tracked updates)
git submodule add https://github.com/cfpeterkozak/bmad-sync-azure-devops _bmad/bmm/workflows/sync-azure-devops

# Option B: Direct copy
cp -r bmad-sync-azure-devops/ your-project/_bmad/bmm/workflows/sync-azure-devops/
```

Then register it in your BMAD manifest files:

**`_bmad/_config/bmad-help.csv`** — add a row:
```
bmm,anytime,Sync Azure DevOps,AD,,_bmad/bmm/workflows/sync-azure-devops/workflow.md,bmad-bmm-sync-azure-devops,false,sm,bmad:...:agent:sm,Bob,Scrum Master,Create/Validate/Edit,Sync BMAD epics stories and tasks to Azure DevOps,output_folder,sync mapping|config|bugs
```

**`_bmad/_config/workflow-manifest.csv`** — add a row:
```
"sync-azure-devops","Sync BMAD epics stories and tasks to Azure DevOps work items with incremental updates","bmm","_bmad/bmm/workflows/sync-azure-devops/workflow.md"
```

## Quick Start

```bash
# 1. Set your PAT (never stored in files)
# PowerShell:
$env:AZURE_DEVOPS_EXT_PAT = "your-personal-access-token"
# Linux/Mac:
export AZURE_DEVOPS_EXT_PAT=your-personal-access-token

# 2. Load the workflow in your AI coding tool
# Tell your agent: "Load and execute _bmad/bmm/workflows/sync-azure-devops/workflow.md"
# Select [C]reate mode
```

On first run, the workflow prompts for:
- **Organization URL** — e.g., `https://dev.azure.com/myorg`
- **Project Name** — must match an existing Azure DevOps project
- **Area Path** — e.g., `MyProject\Backend` (or blank for project root)
- **Iteration Root Path** — parent path for auto-created iterations

These are saved to `devops-sync-config.yaml` for subsequent runs.

## Modes

### [C]reate — Sync BMAD to Azure DevOps

Parses local artifacts, computes content hashes, shows a dry-run summary, and pushes changes after user confirmation.

**Flow:** Init → Parse → Diff → Sync → Complete

| Step | File | What It Does |
|------|------|-------------|
| 1 | `step-01-init.md` | Check prerequisites, load/create config, validate connection, detect process template via `scripts/detect-template.py` |
| 2 | `step-02-parse.md` | Parse all artifacts via `scripts/parse-artifacts.py` (auto-detects heading levels) |
| 3 | `step-03-diff.md` | Batch hash + classify via `scripts/compute-hashes.py`, present dry-run |
| 4 | `step-04-sync.md` | Batch sync via `scripts/sync-devops.py` (cross-platform, error-resilient) |
| 5 | `step-05-complete.md` | Write `devops-sync.yaml` via `scripts/write-sync-state.py`, present final report |

### [V]alidate — Audit Sync State

Re-parses BMAD files, compares against stored hashes AND Azure DevOps live state, queries for new bugs.

**Produces:**
- Drift report (in-sync, local-changed, never-synced, locally-removed, DevOps-missing)
- `devops-bugs.yaml` with any new bugs found in Azure DevOps

### [E]dit — Modify Config

Displays current connection settings, allows field changes, re-validates connection if org/project changed.

## Hierarchy Mapping

| BMAD Source | Azure DevOps Work Item | Created When |
|-------------|----------------------|--------------|
| `epics.md` Epic (`## Epic N:` or `### Epic N:`) | Epic | Create mode |
| `epics.md` Story (`### Story N.M:` or `#### Story N.M:`) | User Story / PBI / Requirement | Create mode |
| Story file Tasks (`- [ ] task`) | Task (parented to Story) | Create mode (after story files exist) |
| Story file Review Follow-ups (`### Review Follow-ups (AI)`) | Task (parented to Story) | Create mode |
| Story file `Status:` field | Work item State | Create mode (mapped per template) |
| `sprint-status.yaml` epic statuses | Epic work item State + Iterations (sub-iterations named by epic slug) | Create mode (state always synced; iteration created when `in-progress` or `done`) |

> **Note:** Epic/Story heading levels vary between projects. The parse script auto-detects the correct levels by scanning for the first `Epic N:` pattern at any heading depth.

### Story File Formats

Story files are discovered in two formats. Flat files are the default output of the BMAD Create Story workflow:

| Format | Example Path | Discovery |
|--------|-------------|-----------|
| **Flat** (preferred) | `implementation-artifacts/1-1-initialize-scaffold.md` | ID extracted from `{N}-{M}-slug.md` filename |
| **Nested** (backward compat) | `implementation-artifacts/1.1/story.md` | ID from directory name |

When both formats exist for the same story ID, the nested directory takes priority (backward compat). The parser performs a 3-pass scan to avoid duplicates.

### Review Follow-ups

AI code review items (from `### Review Follow-ups (AI)` and `### Review Follow-ups Round N (AI)` sections) sync as Task work items parented to their story. Each review item gets a unique ID: `{storyId}-R{round}.{item}` (e.g., `1.1-R1.1`, `1.1-R2.3`).

### Enriched Work Item Fields

Tasks and stories are enriched with additional Azure DevOps fields extracted during parsing. These fields are applied whenever a work item is created or updated, but are **not included in content hashes** (so existing items won't be reclassified on upgrade).

| Source | DevOps Field | Applies To |
|--------|-------------|------------|
| `[HIGH]` / `[MEDIUM]` / `[LOW]` severity tag | Priority (1/2/3) | Review follow-up tasks |
| `[AI-Review]` tag | Tags: `AI-Review` | Review follow-up tasks |
| `[file/path.ext:line]` in description | Description (file context) | Review follow-up tasks |
| Bracket-stripped description | Title (cleaner, shorter) | Review follow-up tasks |
| Subtask checklist | Description (HTML checklist) | Regular tasks with subtasks |
| `(AC: 1, 3)` pattern | Description (AC references) | Regular tasks |
| Story `.md` file | Attached file (via REST API) | Stories |

**Story file attachments** require `attachStoryFiles: "true"` in your config. Authentication uses `AZURE_DEVOPS_EXT_PAT` (Basic auth) or falls back to `az account get-access-token` (Bearer auth) if the PAT is not set. The story markdown file is uploaded via the Azure DevOps REST API and linked as an AttachedFile relation. Previously-synced stories missing attachments are automatically backfilled on the next sync run.

### Status Sync (Stories and Epics)

Both story and epic statuses are synced to Azure DevOps work item state:

| BMAD Status | Agile | Scrum | CMMI | Basic | Used By |
|-------------|-------|-------|------|-------|---------|
| `draft` | New | New | Proposed | To Do | Stories |
| `backlog` | New | New | Proposed | To Do | Epics |
| `in-progress` | Active | Committed | Active | Doing | Both |
| `review` | Active | Committed | Active | Doing | Stories |
| `done` | Closed | Done | Resolved | Done | Both |
| *(not set)* | *(no change)* | *(no change)* | *(no change)* | *(no change)* | |

- **Story status** comes from the `Status:` field in individual story files
- **Epic status** comes from the `development_status:` block in `sprint-status.yaml`

> **Note:** `review` maps identically to `in-progress` since standard Azure DevOps templates lack a Review state.

The Story work item type adapts to your Azure DevOps process template (auto-detected):

| Template | Story Type | AC Field |
|----------|-----------|----------|
| Agile | User Story | AcceptanceCriteria |
| Scrum | Product Backlog Item | AcceptanceCriteria |
| CMMI | Requirement | AcceptanceCriteria |
| Basic | Issue | Description (no dedicated AC field) |

## Output Files

All output files are written to your BMAD project's `{output_folder}` directory.

### devops-sync-config.yaml

Connection configuration. Created on first run, reused on subsequent runs.

```yaml
organizationUrl: "https://dev.azure.com/myorg"
projectName: "MyProject"
areaPath: "MyProject\\Backend"
iterationRootPath: "MyProject\\Iterations"
processTemplate: "Scrum"
attachStoryFiles: "false"
```

- **`attachStoryFiles`**: When `"true"`, story `.md` files are uploaded and attached to their Azure DevOps work items during sync. Default is `"false"` (opt-in). Toggle via Edit mode.

### devops-sync.yaml

Mapping file linking BMAD IDs to Azure DevOps work item IDs with content hashes for change detection.

```yaml
lastFullSync: "2026-03-01T14:30:00Z"
epics:
  "1":
    devopsId: 12345
    contentHash: "a1b2c3d4e5f6"
    lastSynced: "2026-03-01T14:30:00Z"
    status: "synced"
stories:
  "1.1":
    devopsId: 12346
    epicDevopsId: 12345
    contentHash: "d4e5f6g7h8i9"
    lastSynced: "2026-03-01T14:30:00Z"
    status: "synced"
    attached: true
tasks:
  "1.1-T1":
    devopsId: 12347
    storyDevopsId: 12346
    contentHash: "g7h8i9j0k1l2"
    lastSynced: "2026-03-01T14:30:00Z"
    status: "synced"
iterations:
  "epic-1-foundation-infrastructure-platform-bootstrap":
    epicId: "1"
    devopsId: "iteration-guid-here"
    lastSynced: "2026-03-01T14:30:00Z"
```

### devops-bugs.yaml

Bugs discovered in Azure DevOps during Validate mode.

```yaml
lastChecked: "2026-03-05T10:00:00Z"
bugs:
  - devopsId: 99
    title: "Login fails on Edge"
    state: "Active"
    assignedTo: "dev@company.com"
    createdDate: "2026-03-04"
    description: "..."
    bmadStatus: "new"   # new | triaged | fixed
```

## Content Hash-Based Change Detection

The workflow uses normalized SHA-256 hashes (first 12 hex chars) to detect changes without false positives from formatting differences. All hashing is performed by `scripts/compute-hashes.py` using Python's `hashlib` — no shell commands or external tools needed.

**Normalization pipeline:** trim whitespace → collapse spaces → lowercase → sort lists → join with `|`

| Item Type | Hash Inputs |
|-----------|------------|
| Epic | title + description + phase + sorted requirements + epic status |
| Story | title + user story text + acceptance criteria block + status |
| Task | task description + checkbox state (complete/incomplete) |

> **Note:** Story status is included in the story hash so that status changes (e.g., `in-progress` → `done`) trigger a CHANGED classification and state sync. Epic status from `sprint-status.yaml` is included in the epic hash so that epic status changes trigger iteration creation. Review follow-up tasks use the same hash formula as regular tasks.
>
> **Enriched fields** (priority, tags, file path, subtask HTML, AC references, clean title) are **excluded from hashes** to maintain backward compatibility. Adding them would cause every existing item to reclassify as CHANGED on first run after upgrade. Instead, enriched fields are applied whenever sync touches an item (NEW or CHANGED).

Re-running Create mode only pushes items whose hash changed since last sync.

## Incremental Sync Behavior

| Item State | Action |
|------------|--------|
| **New** (not in sync file) | Create in Azure DevOps |
| **Changed** (hash differs) | Update in Azure DevOps |
| **Unchanged** (hash matches) | Skip (but backfill attachment if `attached` flag missing and `attachStoryFiles` enabled) |
| **Orphaned** (in DevOps, not in BMAD) | Warn only — never auto-deleted |
| **Failed** (API error) | Mark as "pending" for retry on next sync |

## Integration with Other BMAD Workflows

| BMAD Workflow | Integration Point |
|---------------|-------------------|
| **Create Epics and Stories** | Produces `epics.md` — the primary input for this workflow |
| **Sprint Planning** | Produces `sprint-status.yaml` with `development_status:` → consumed by Create mode for epic-based Iteration creation |
| **Sprint Status** | Can read `devops-sync.yaml` `lastFullSync` timestamp to warn about unsynced changes |
| **Create Story** | Generates story files with Tasks/Subtasks → consumed by Create mode for Task sync |
| **Dev Story** | Updates task checkboxes and story Status → detected as CHANGED on next Create mode run |
| **Code Review** | Adds Review Follow-ups sections → synced as Task work items on next Create mode run |

## Error Handling

| Error | Behavior |
|-------|----------|
| Azure CLI not installed | HALT with install link |
| PAT not set | HALT with export command |
| Connection failure | HALT with guidance |
| Individual work item failure | Log, skip, continue — report in summary |
| Rate limited (429) | Wait 60s, retry once |

## Troubleshooting

**"AZURE_DEVOPS_EXT_PAT not set"**
Set the environment variable in the same shell session where your AI agent runs:
- PowerShell: `$env:AZURE_DEVOPS_EXT_PAT = "your-token"`
- Bash: `export AZURE_DEVOPS_EXT_PAT=your-token`

**"azure-devops extension not found"**
Run: `az extension add --name azure-devops`

**"Project not found"**
Verify your organization URL includes the org name (e.g., `https://dev.azure.com/myorg`, not `https://dev.azure.com`). Verify the project name matches exactly (case-sensitive).

**"TF237111: permissions to save work items"**
Your PAT needs **Work Items: Read, write, & manage** scope (not just Read & Write). Regenerate the token with the correct scope.

**Wrong work item types created**
The process template may have been misdetected. Run Edit mode to re-validate connection — template is re-detected automatically. You can also run the detection script directly: `python scripts/detect-template.py --org <URL> --project <NAME>`

**Script says "AZURE_DEVOPS_EXT_PAT not set" but it is set**
Ensure the variable is set in the same shell session where the AI agent invokes the scripts. Some IDE terminals don't inherit environment variables from other shells. On Windows PowerShell: `$env:AZURE_DEVOPS_EXT_PAT = "your-token"`. On Linux/Mac: `export AZURE_DEVOPS_EXT_PAT=your-token`.

**Story attachments not appearing**
Ensure `attachStoryFiles: "true"` is set in `devops-sync-config.yaml`. The feature defaults to `false`. Authentication requires either `AZURE_DEVOPS_EXT_PAT` or an active `az login` session (the script falls back to `az account get-access-token`). If your PAT lacks sufficient scope, the upload will fail silently — check the sync stderr output for `WARNING: Attachment upload failed` messages. Previously-synced stories without attachments are automatically backfilled on the next run.

**`az.cmd` not found on Windows**
The sync script auto-detects `az.cmd` via `shutil.which`. If detection fails, ensure `az` is on your `PATH`. Run `where az` in CMD or `Get-Command az` in PowerShell to verify.

**"All items unchanged" but changes were made**
Content hashes use normalized input. If only whitespace or formatting changed (no actual content change), the hash won't differ. This is intentional to avoid false diffs.

**Bugs not appearing in devops-bugs.yaml**
Validate mode queries bugs under the configured Area Path only. If bugs are filed under a different area path, they won't be found. Check your area path configuration with Edit mode.

## File Structure

```
bmad-sync-azure-devops/
├── README.md                            # This documentation
├── workflow.md                          # Entry point: [C]reate / [V]alidate / [E]dit
├── scripts/                            # Cross-platform Python helper scripts (stdlib only)
│   ├── detect-template.py              # Process template detection via REST API
│   ├── parse-artifacts.py              # Parse epics.md + story files + epic statuses
│   ├── compute-hashes.py              # Batch SHA-256 hashing + diff classification
│   ├── sync-devops.py                 # Batch az CLI execution with error resilience
│   └── write-sync-state.py            # Deterministic YAML state file writer
├── data/
│   ├── azure-devops-cli.md             # az boards CLI command reference + cross-platform notes
│   └── parsing-patterns.md             # Regex patterns (flexible heading levels), hash scopes
├── steps-c/                            # Create mode steps
│   ├── step-01-init.md                 # Prerequisites + config + connection
│   ├── step-02-parse.md                # Parse all artifacts via script
│   ├── step-03-diff.md                 # Batch hash + classify via script + dry-run summary
│   ├── step-04-sync.md                 # Batch sync via script
│   └── step-05-complete.md             # Write mapping file + report
├── steps-v/                            # Validate mode
│   └── step-01-validate.md             # Drift detection + bug discovery
└── steps-e/                            # Edit mode
    └── step-01-edit-config.md          # Modify connection config
```

## Helper Scripts

The `scripts/` directory contains four Python scripts that replace error-prone shell-per-item approaches with reliable, cross-platform batch operations. All scripts use **Python stdlib only** (no pip install) and work on Windows, Mac, and Linux.

| Script | Replaces | Key Benefit |
|--------|----------|-------------|
| `detect-template.py` | Nonexistent `az boards work-item type list` CLI command | Uses REST API directly via `urllib.request` |
| `parse-artifacts.py` | AI-written ad-hoc parser that broke on different heading levels | Auto-detects `##`/`###`/`####` heading levels |
| `compute-hashes.py` | 100+ individual `sha256sum` / PowerShell shell calls | Single batch operation via `hashlib` |
| `sync-devops.py` | AI-written batch script with `az.cmd` path issues on Windows | Auto-detects `az` path via `shutil.which`, enriches tasks with priority/tags/description, attaches story files via REST API |
| `write-sync-state.py` | Error-prone LLM YAML generation in step 05 | Deterministic merge of diff + sync results into `devops-sync.yaml` |

Each step file references its script via frontmatter (e.g., `parseScript: '../scripts/parse-artifacts.py'`). If Python is unavailable, fallback instructions are provided in each step.

## Known Limitations

1. **Bug lifecycle gap**: `devops-bugs.yaml` tracks `bmadStatus` (new/triaged/fixed) but no BMAD workflow currently updates this status. Triage is manual.
2. **No auto-delete**: Orphaned items in Azure DevOps are never deleted automatically. Remove manually if needed.
3. **One-way content sync**: Content flows BMAD → Azure DevOps. Edits made directly in Azure DevOps are not synced back to BMAD files.
4. **State sync is one-way**: Epic, story, and task state sync from BMAD → DevOps, but DevOps state changes don't flow back to BMAD files.

## License

MIT
